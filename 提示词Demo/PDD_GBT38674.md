# **AI驱动安全开发 - 提示词示例库 (补充)**

## **1. 数据清洗 - SQL注入防护 (讲义P41-45, P92-94)**
这个场景用于演示如何通过精确提示词，从源头上杜绝最经典、危害最大的SQL注入漏洞。

### **“错误”的提示 (Vague Prompt):**
```text
请用Python写一个函数，根据用户ID从数据库里查找用户的信息。
```
**点评**: 这是一个典型的模糊指令，极易诱导AI生成使用字符串拼接SQL语句的不安全代码，从而引入SQL注入漏洞。


### **“AI驱动的、符合规范”的精确提示 (Secure PDD Prompt):**
```markdown
请基于Python和`psycopg2`库，编写一个安全的函数，用于根据用户`id`从PostgreSQL数据库的`users`表中查询用户信息。

**核心要求**:  
严格遵循《GB/T 38674》中关于“数据操作安全”和“命令构建验证”的规范（讲义P42, P92），**必须使用参数化查询（prepared statements）** 来防止SQL注入攻击。

**函数规格**:  
- 函数名: `get_user_by_id`  
- 输入参数: `user_id` (整数类型)  
- 返回值: 成功时返回用户信息（如字典），失败或未找到则返回`None`。  
- 请包含完整的数据库连接、执行查询和关闭连接的逻辑。
```
**点评**: 通过精准的提示词，AI可以作为“规范执行者” (代码生成)

## **2. 数据加密与保护 - 硬编码密钥防护 (讲义P49-51)**
这个场景用于教学员识别和修复代码中的“硬编码密钥”这一严重的安全隐患，并理解AI在其中的双重角色。

### **场景一：AI作为“安全导师” (知识问答)**
```text
我是一名Java开发者。请根据《GB/T 38674》中关于“密钥安全维护”和“禁止硬编码密钥”的要求（讲义P50），用一个表格对比分析，在代码中硬编码加密密钥的风险，并提供一个使用环境变量来安全加载密钥的规范示例。
```
### **场景二：AI作为“规范审计者” (代码审计)**
#### **审计提示 (Audit Prompt):**
````markdown
你是一名代码审计专家。请审计以下Java代码片段。
```java
// 待审计的不安全代码 (Vulnerable Code Snippet)
import javax.crypto.Cipher;  
import javax.crypto.spec.SecretKeySpec;  
import java.util.Base64;

public class UnsafeEncryption {  
    // 风险点：密钥被硬编码在代码中  
    private static final String SECRET\_KEY \= "mySuperSecretKey123\!@\#";

    public String encrypt(String data) throws Exception {  
        SecretKeySpec secretKey \= new SecretKeySpec(SECRET\_KEY.getBytes(), "AES");  
        Cipher cipher \= Cipher.getInstance("AES");  
        cipher.init(Cipher.ENCRYPT\_MODE, secretKey);  
        byte\[\] encryptedBytes \= cipher.doFinal(data.getBytes());  
        return Base64.getEncoder().encodeToString(encryptedBytes);  
    }  
}
```
**任务**:  
1. 根据《GB/T 38674》的要求“密钥需通过安全渠道（如环境变量、 KMS）动态获取，禁止在代码或配置文件中明文存储”，判断它是否存在“硬编码密钥”的安全漏洞。  
2. 如果存在，请详细说明其风险。  
3. 提供一份详细的、可操作的修复建议，展示如何从环境变量或安全配置文件中加载密钥，以替代硬编码。
````

## **3. 访问控制 - 不安全直接对象引用(IDOR)防护 (讲义P62-64)**

这个场景用于演示在设计API时，如何通过提示词强制AI实现业务逻辑层面的权限校验，防止用户越权访问不属于自己的数据。

### **“错误”的提示 (Vague Prompt):**
```text
请用Java Spring Boot框架写一个API，可以通过订单ID查询订单详情。
```
**点评**: 这个提示只描述了功能，完全没有提及权限控制。AI生成的代码很可能只根据ID查询，导致任何认证用户都可以查询任意订单，造成严重的越权漏洞。

### **对错误提示生成的代码进行审查改进**
```markdown
请你根据以下要求，审查你刚才提供的代码：
遵循《GB/T 38674》中关于“权限管理”和“数据操作检查”的规范，在执行数据库查询前，**必须强制校验当前已认证的用户是否有权查看该`orderId`对应的订单**。
```
### **“AI驱动的、符合规范”的精确提示 (Secure PDD Prompt):**
```markdown
请使用Java Spring Boot框架，设计一个安全的REST API端点 `/api/orders/{orderId}` 来获取订单详情。

**核心安全要求**:  
严格遵循《GB/T 38674》中关于“权限管理”和“数据操作检查”的规范，在执行数据库查询前，**必须强制校验当前已认证的用户是否有权查看该`orderId`对应的订单**。

**实现逻辑**:  
1. 从安全上下文（Security Context）中获取当前登录用户的ID。  
2. 在查询订单时，SQL查询条件必须同时包含`orderId`和`userId`。  
3. 如果订单不存在或不属于当前用户，应返回404 Not Found或403 Forbidden。  
4. 请展示Controller层和Service层的关键代码实现。
```
**点评**: AI作为“规范执行者” 实现安全API设计

## **4. 并发程序安全 - 死锁预防 (讲义P72-74)**
这个场景用于展示AI在处理更复杂的编程概念（如多线程和并发）时的能力，既可以作为导师解释概念，也可以作为开发者实现线程安全的逻辑。

### **场景：AI作为“安全导师” (概念解释与代码演示)**
```markdown
请根据《GB/T 38674》“并发程序安全”章节，用Java代码生动地演示一个由于“锁顺序不一致”而导致两个线程发生“死锁”的经典场景。

**要求**:  
1. 创建两个线程和两个共享锁对象。  
2. 让每个线程以相反的顺序去获取这两个锁，从而触发死锁。  
3. 在代码中用注释清晰地标示出死锁发生的原因。  
4. 最后，请简要说明如何通过遵循“锁顺序一致性”原则来修复这个死锁问题。  
```

## **5. 日志安全 - 日志注入与敏感信息泄露防护 (讲义P65-67)**
这个场景用于演示如何防止攻击者通过伪造日志内容（如注入换行符`\n`）来混淆视听，以及如何避免在日志中记录密码等敏感信息。

### **“错误”的提示 (Vague Prompt):**
```markdown
我需要记录用户登录的用户名和密码，方便排查问题。请用`Log4j2`写一下。
```
**点评**: 这是一个极其危险的请求。它不仅会导致在日志中明文记录密码，还可能因为直接拼接用户输入而产生日志注入风险。

### “AI驱动的、符合规范”的精确提示 (Secure PDD Prompt):
```markdown
请使用Java和`Log4j2`，编写一个安全的用户登录日志记录函数。

**核心安全要求**:
严格遵循《GB/T 38674》“日志安全”规范，确保：
1.  **避免敏感数据泄露**: **绝对禁止**在日志中记录用户密码或任何其他敏感凭证。
2.  **输入过滤与转义**: 对所有写入日志的用户输入（如用户名）进行处理，过滤掉CR/LF字符（如`\r`, `\n`），以防止日志伪造或日志注入攻击。
3.  **记录关键事件**: 应记录登录尝试的结果（成功/失败）以及来源IP地址。

**函数规格**:
-   输入参数: `username` (String), `ipAddress` (String), `isSuccess` (boolean)
-   日志级别: 成功登录使用`INFO`级别，失败登录使用`WARN`级别。
-   请展示具体的实现代码。
```
**点评**: AI作为“规范执行者” 实现安全日志记录

## **6. 代码实现安全-面向对象程序安全（讲义P69）**
```text
我不理解什么是‘防御性复制’，在Java中它为什么重要？请根据《GB/T 38674》数据封装与访问控制之
防御性复制的要求：返回可变对象的副本，防止外部修改内部状态，给我一个具体的代码示例。
```

## **7. 异常处理安全 - 敏感信息屏蔽 (讲义P77-78)**
这个场景用于教学员理解，不当的异常处理会暴露系统内部的技术细节（如堆栈跟踪、数据库错误信息），为攻击者提供便利。

### 场景：AI作为“规范审计者” (代码审计)
#### 审计提示 (Audit Prompt):
````markdown
你是一名代码审计专家。请审计以下Python Flask代码片段。
```python
# 待审计的不安全代码 (Vulnerable Code Snippet)
from flask import Flask, request

app = Flask(__name__)

@app.route("/user")
def get_user_profile():
    user_id = request.args.get('id')
    try:
        # 假设这里有一个函数，会连接数据库并可能抛出异常
        # E.g., database_connector.find_user(user_id)
        if user_id == "error":
             raise Exception("数据库连接失败: 'user'@'localhost' 密码错误")
        return f"成功获取用户 {user_id} 的信息"
    except Exception as e:
        # 风险点：直接将详细的异常信息返回给用户
        return f"处理请求时发生错误: {str(e)}", 500

if __name__ == "__main__":
    app.run()
``` 
**任务**:
1.  根据《GB/T 38674》中关于“异常处理安全”和“隐藏敏感信息”的要求，判断它是否存在向用户泄露过多内部错误细节的安全风险。
2.  如果存在，请详细说明这种信息泄露可能带来的危害。
3.  提供一份详细的修复建议，展示如何实现一个安全的异常处理机制：既能在服务端记录完整的错误日志用于调试，又只向用户返回一个通用的、不包含敏感信息的错误提示。
````

## **8. 资源使用安全-文件管理 (讲义P95-97)。**

### “错误”的提示：
```text
请用Python写一个文件上传功能。
```
这种模糊的提示很可能导致AI生成不安全的代码，比如未验证文件类型、存在路径遍历风险等。

### “AI驱动的、符合规范”的精确提示：
```markdown
请基于Python Flask框架，编写一个安全的文件上传函数。
## 要求
严格遵循《GB/T 38674》文件管理安全要求，包括但不限于以下几点：
- 文件路径验证：对上传的文件名进行清理，防止路径遍历攻击（如'../'）。
- 文件类型验证：不仅检查文件扩展名，还要读取文件头（Magic Number）来确认文件类型，仅允许上传'.png'和'.jpg'格式的图片。
- 临时文件管理：使用安全的临时文件存储，并确保操作后清理。
- 权限控制：确保上传目录不可执行。
- 请将所有的依赖项写入requirements.txt。
```

### 代码审计提示
```markdown
你是一名资深信息安全专家和代码审计顾问，具备丰富的漏洞识别与修复经验，熟悉包括 Web 安全、系统安全、加密实现、内存安全等多个领域。请对`.\secure_file_upload_demo\`目录下的代码进行深入分析，任务如下：
## 审计目标：
 	- 识别所有可能存在的安全漏洞，包括但不限于：
 	   - 输入验证缺陷（如SQL注入、XSS、命令注入等）
 	   - 权限控制问题（如越权访问、任意文件读写）
 	   - 内存问题（如缓冲区溢出、Use-After-Free）
 	   - 加密错误（如弱加密、不安全随机数、硬编码秘钥）
 	   - 第三方依赖滥用（如不安全调用、版本漏洞）
 	- 对每一个漏洞进行结构化输出，内容包括：
 	   - 漏洞名称
 	   - 漏洞描述
       - 漏洞位置（尽量标明行号、函数或模块名）
      - 风险等级（高 / 中 / 低）
      - 潜在危害/利用方式
      - 详细修复建议（包括代码修改建议、安全加固措施等）
      - 修复后效果说明（说明为何可防止攻击）
## 附加要求：
 	- 如果可行，请参考 OWASP Top 10 / CWE 编号 / CVSS 风险评估。
 	- 若有多个问题，请逐项列出，不要遗漏中低危问题。
 	- 对于每个修复建议，务必给出详细技术细节，可操作示例代码，以及修复前后对比。
请一次性完成全部的审计工作，并以markdown格式生成“安全审计报告.md”文件
```

### 根据代码审计报告迭代优化代码
```markdown
我们对你写的文件进行了安全审计，并在`secure_file_upload_demo`目录中生成了`安全审计报告.md`。请你根据安全审计报告对项目进行改进。 
```

### 复审迭代优化代码
```markdown
我们已经根据安全审计报告进行了项目改进，请按照前述审计需求，对项目重新审计，并生成新的审计报告`安全审计报告(复审).md`。
```

